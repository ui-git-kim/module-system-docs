---
title: LLM Rules
description: Authoritative rules for AI assistants working with the Module System
tableOfContents:
  maxHeadingLevel: 2
---

import { Aside, Steps, Tabs, TabItem } from '@astrojs/starlight/components';

This document defines the authoritative rules for AI assistants (Claude, GPT, etc.) working across the Module System. All `CLAUDE.md` files should reference this document.

---

## Critical Rules (Read First)

These rules are **mandatory** and must be followed on every task.

### 1. Version Bumping

**When you modify ANY of these files, you MUST bump the version:**

```
frontend/src/config/*.ts     # Registry files
frontend/src/lib/*.ts        # Utility libraries
backend/src/config/*.ts      # Registry files
backend/src/lib/*.ts         # Utility libraries
backend/src/middleware/*.ts  # Middleware
create-app.ps1, create-app.sh, update-template.ps1, update-template.sh
scripts/*.ps1, scripts/*.sh
```

**What to do:**
```bash
# After modifying any file above, run ONE of:
npm run template:version:patch   # Bug fixes, typos
npm run template:version:minor   # New features
npm run template:version:major   # Breaking changes
```

<Aside type="danger">
  Never skip this. Apps track template versions. Missing bumps break the update system.
</Aside>

### 2. Push Documentation Changes

**When you edit ANY file in `docs/`, you MUST push:**

```bash
# 1. Commit in submodule
cd docs && git add . && git commit -m "Docs: description"

# 2. PUSH (triggers deploy to live site)
git push

# 3. Update parent repo
cd .. && git add docs && git commit -m "Update docs submodule"
```

<Aside type="danger">
  Unpushed docs = live site not updated. Always push.
</Aside>

### 3. Backend Import Extensions

**Always use `.js` extension for relative imports in backend:**

```typescript
// ✅ Correct
import { prisma } from '../../lib/prisma.js';
import { userService } from './user.service.js';

// ❌ Wrong - fails at runtime
import { prisma } from '../../lib/prisma';
```

### 4. File Headers

**Every new file needs a header:**

```typescript
// ========================================================================
// FILE: [path/from/repo/root]
// PURPOSE: [one-line description]
// ========================================================================
```

### 5. Registry Pattern

**Never modify core files for new features.** Use registrations:

```typescript
// ✅ Correct - create navigation.registration.ts
navigationRegistry.registerMain({
  id: 'my-feature',
  title: 'My Feature',
  url: '/my-feature',
  icon: MyIcon,
  order: 30,
});

// ❌ Wrong - editing routes.tsx or app.ts directly
```

---

## Spelling Conventions

**Australian spelling** in prose, **American spelling** in code.

| Context | Use | Example |
|---------|-----|---------|
| Documentation, comments, UI text | Australian | colour, behaviour, organisation |
| Variable names, functions, CSS | American | `backgroundColor`, `customizeSettings` |

---

## Critical System Knowledge

### Auth URL Must Match Exactly

Frontend and backend must use **identical** auth URLs:

```env
# Both must be identical (including /neondb/auth path)
VITE_NEON_AUTH_URL=https://xxx.neonauth.region.aws.neon.tech/neondb/auth
NEON_AUTH_URL=https://xxx.neonauth.region.aws.neon.tech/neondb/auth
```

### Database URLs

Neon requires **two** URLs:

| Variable | Pattern | Use For |
|----------|---------|---------|
| `DATABASE_URL` | has `-pooler` | App queries |
| `DIRECT_DATABASE_URL` | no `-pooler` | Migrations only |

### Database Migrations

**Always use `migrate dev`, never `db push`:**

```bash
cd backend && npx prisma migrate dev --name describe_change
```

---

## Registry System

### Type Names

Use the **full type names** from registry files:

| Registry | Item Type (Use This) | NOT |
|----------|---------------------|-----|
| `navigationRegistry` | `NavigationItem` | ~~NavItem~~ |
| `dashboardRegistry` | `DashboardWidget` | ~~Widget~~ |
| `settingsPagesRegistry` | `SettingsPage` | ~~SettingPage~~ |
| `headerToolbarRegistry` | `HeaderToolbarItem` | ~~ToolbarItem~~ |

### Order Values

| Range | Use For |
|-------|---------|
| 1-9 | Core/system items |
| 10-29 | Primary features (Dashboard, Home) |
| 30-49 | Main features |
| 50-69 | Secondary features |
| 70-89 | Settings, admin |
| 90-99 | Footer items, logout |
| 100+ | Third-party plugins |

**Lower numbers = appears first / runs first**

---

## Feature Architecture

### Frontend Structure

```
frontend/src/features/[feature]/
├── index.ts                    # Exports + registration imports
├── routes.config.tsx           # Route definitions
├── navigation.registration.ts  # Registry registration
├── components/                 # UI components
├── pages/                      # Page components
├── services/                   # API service layer
├── hooks/                      # Custom hooks
└── types/                      # TypeScript types
```

### Backend Structure

```
backend/src/features/[feature]/
├── index.ts                    # Exports + registration imports
├── [feature].routes.ts         # Express routes
├── [feature].service.ts        # Business logic
├── [feature].types.ts          # Types
├── route.registration.ts       # Route registry
└── service.registration.ts     # Service registry
```

---

## Code Conventions

### Import Order

1. External packages (react, express)
2. Internal absolute imports (`@/...`)
3. Relative imports (`./`, `../`)

### Naming

| Item | Convention | Example |
|------|------------|---------|
| Files | kebab-case | `user-profile.tsx` |
| Components | PascalCase | `UserProfile` |
| Functions | camelCase | `getUserProfile` |
| Constants | SCREAMING_SNAKE | `API_BASE_URL` |
| Registry files | `*.registry.ts` | `navigation.registry.ts` |
| Registration files | `*.registration.ts` | `navigation.registration.ts` |

### TypeScript

- No `any` unless absolutely necessary
- Prefer `interface` over `type` for objects
- Use `unknown` instead of `any` when truly unknown

---

## Common Mistakes

| Mistake | Fix |
|---------|-----|
| Missing `.js` in backend imports | Always: `import { x } from './file.js'` |
| Using `NavItem` instead of `NavigationItem` | Use full type names from registry files |
| Editing `components/ui/` | Never edit shadcn - regenerate instead |
| Modifying `routes.tsx` for features | Use registration files |
| Using `db push` | Use `prisma migrate dev` |
| Forgetting to push docs | Always push after editing docs/ |
| Forgetting version bump | Always bump after infrastructure changes |

---

## Error Handling

Use HTTP-aware errors from `lib/errors.ts`:

```typescript
import { NotFoundError, UnauthorizedError } from '../../lib/errors.js';

if (!item) throw new NotFoundError('Item not found');
if (!user) throw new UnauthorizedError('Unauthorized');
```

| Error | Code | Use For |
|-------|------|---------|
| `BadRequestError` | 400 | Invalid input |
| `UnauthorizedError` | 401 | Auth required |
| `ForbiddenError` | 403 | Permission denied |
| `NotFoundError` | 404 | Resource not found |
| `ConflictError` | 409 | Duplicate/conflict |
| `TooManyRequestsError` | 429 | Rate limiting |

---

## Database Operations

```typescript
// Always import from lib
import { prisma } from '../../lib/prisma.js';

// Use transactions for multi-table operations
import { withTransaction } from '../../lib/prisma.js';

const result = await withTransaction(async (tx) => {
  const user = await tx.user.create({ data: { ... } });
  const settings = await tx.settings.create({ data: { userId: user.id } });
  return { user, settings };
});
```

### User Routes Pattern

Always use `getOrCreateProfile` to ensure user exists:

```typescript
router.get('/profile', requireAuth, async (req, res) => {
  const profile = await userService.getOrCreateProfile(req.user!.id, req.user!.email);
  res.json(profile);
});
```

---

## Shell Script Rules

When working on `create-app.*` or `update-template.*` scripts:

### Cross-Platform Sync

**Always update both `.ps1` AND `.sh` versions.**

### Git Commands in Scripts

```bash
# ✅ Always use --no-pager
git --no-pager log --oneline
git --no-pager diff --stat

# ❌ Opens pager, blocks script
git log --oneline
```

### File Content from Git

```bash
# ✅ Preserves exact content
git checkout "remote/branch" -- filename

# ❌ Loses newlines, corrupts files
CONTENT=$(git show "remote/branch:file")
echo "$CONTENT" > file
```

### Self-Updating Scripts

1. Use `git checkout` to get new version
2. Immediately `git add` and `git commit`
3. `git push` before re-executing
4. Wait 2 seconds after push
5. Save original args: `ORIGINAL_ARGS=("$@")`
6. Re-execute: `exec "$0" "${ORIGINAL_ARGS[@]}"`

---

## Do and Don't

### DO

- ✅ Follow feature-based architecture
- ✅ Use registry pattern for extensibility
- ✅ Add file headers to all files
- ✅ Use `.js` extensions in backend imports
- ✅ Use Australian spelling in documentation
- ✅ Bump version after infrastructure changes
- ✅ Push docs after editing documentation
- ✅ Use named exports (not default)

### DON'T

- ❌ Modify `components/ui/` directly
- ❌ Put business logic in route handlers
- ❌ Hardcode URLs
- ❌ Skip TypeScript types
- ❌ Create files without headers
- ❌ Commit `.env` files
- ❌ Modify core files for features
- ❌ Use `db push` instead of `migrate dev`

---

## Git Commit Messages

```
type(scope): description

Co-Authored-By: Claude <assistant>
```

Types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `chore`

---

## Testing Checklist

Before considering work complete:

- [ ] TypeScript compiles: `npm run type-check`
- [ ] Frontend runs: `npm run dev:frontend`
- [ ] Backend runs: `npm run dev:backend`
- [ ] Auth works: Can sign in/out
- [ ] API works: No 401 errors
- [ ] Registrations appear correctly
- [ ] **Version bumped** (if infrastructure changed)
- [ ] **Docs pushed** (if documentation changed)

---

## Quick Reference

### Version Commands

```bash
# Starter template
npm run template:version:patch   # 1.2.0 → 1.2.1
npm run template:version:minor   # 1.2.0 → 1.3.0
npm run template:version:major   # 1.2.0 → 2.0.0

# Modules
npm run release:patch
npm run release:minor
npm run release:major
```

### Common Commands

```bash
npm run dev                    # Run both frontend and backend
npm run type-check             # Check TypeScript

cd backend && npx prisma studio        # Database GUI
cd backend && npx prisma migrate dev   # Run migrations

cd frontend && npx shadcn@latest add [component]
```

### Environment Variables

| Variable | Location | Must Match? |
|----------|----------|-------------|
| `VITE_NEON_AUTH_URL` | frontend | Yes - identical |
| `NEON_AUTH_URL` | backend | Yes - identical |
| `DATABASE_URL` | backend | Has `-pooler` |
| `DIRECT_DATABASE_URL` | backend | No `-pooler` |

---

## Referencing These Rules

Add to your CLAUDE.md:

```markdown
## LLM Rules Reference

For comprehensive rules, see: **https://saas.uniqueicon.com.au/getting-started/llm-rules/**

**Critical rules:**
1. **Bump version** after modifying config/, lib/, middleware/, scripts/
2. **Push docs** after editing documentation
3. **Add file headers** to all new files
4. **Use registry pattern** for extensibility
5. **Use .js extensions** in backend imports
```
