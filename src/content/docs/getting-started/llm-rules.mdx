---
title: LLM Rules
description: Authoritative rules for AI assistants working with the Module System
tableOfContents:
  maxHeadingLevel: 2
---

import { Aside, Steps, Tabs, TabItem } from '@astrojs/starlight/components';

This document defines the authoritative rules for AI assistants (Claude, GPT, etc.) working across the Module System. All `CLAUDE.md` files should reference this document for consistent behaviour.

<Aside type="tip">
  Add this to your CLAUDE.md: `For detailed rules, see https://saas.uniqueicon.com.au/getting-started/llm-rules/`
</Aside>

---

## Version Bumping (MANDATORY)

When modifying infrastructure files, you **MUST** bump the version. This is not optional.

### Files That Require Version Bump

**Starter Template:**
```
frontend/src/config/*.ts     # Registry files
frontend/src/lib/*.ts        # Utility libraries
backend/src/config/*.ts      # Registry files
backend/src/lib/*.ts         # Utility libraries
backend/src/middleware/*.ts  # Middleware
create-app.ps1, create-app.sh
update-template.ps1, update-template.sh
scripts/*.ps1, scripts/*.sh
```

**Module Starter:**
```
src/templates/**/*           # Code templates
src/scaffold/**/*            # Scaffold infrastructure
src/config/*.ts              # Configuration
```

**Individual Modules:**
```
src/templates/**/*           # Module templates
src/module.ts                # Module definition
Any file that affects generated output
```

### How to Bump Version

<Tabs>
  <TabItem label="Starter Template">
    ```bash
    # Patch (bug fixes): 1.2.0 → 1.2.1
    npm run template:version:patch

    # Minor (new features): 1.2.0 → 1.3.0
    npm run template:version:minor

    # Major (breaking changes): 1.2.0 → 2.0.0
    npm run template:version:major
    ```
  </TabItem>
  <TabItem label="Modules">
    ```bash
    # Patch
    npm run release:patch

    # Minor
    npm run release:minor

    # Major
    npm run release:major
    ```
  </TabItem>
</Tabs>

### When to Use Each Bump Type

| Type | Use For | Examples |
|------|---------|----------|
| **patch** | Bug fixes, typo corrections, minor tweaks | Fix registry ordering, correct type error |
| **minor** | New features, new registry entries, enhancements | Add new registry, new middleware, new template |
| **major** | Breaking changes to APIs or interfaces | Change registry interface, rename exports |

### Version Bump Workflow

<Steps>
1. Make your changes to the infrastructure files
2. Run the appropriate version bump command
3. Commit the version bump in the same commit (or immediately after)
4. The bump script handles VERSION file, package.json, and module.ts automatically
</Steps>

<Aside type="caution">
  Never skip version bumping. Apps use version numbers to track template updates. Missing version bumps break the update system.
</Aside>

---

## Code Conventions

### File Headers

**Every file** must have a header comment:

```typescript
// ========================================================================
// FILE: [path/from/repo/root]
// PURPOSE: [one-line description]
// DESCRIPTION: [optional longer description for complex files]
// ========================================================================
```

Example:
```typescript
// ========================================================================
// FILE: frontend/src/config/navigation.registry.ts
// PURPOSE: Singleton registry for sidebar and user menu navigation items
// ========================================================================
```

### Section Dividers

Use section dividers for logical groupings:

```typescript
// ========================================================================
// TYPES
// ========================================================================

interface MyType { ... }

// ========================================================================
// REGISTRY
// ========================================================================

export const myRegistry = new BaseRegistry<MyType>('my-registry');

// ========================================================================
// EXPORTS
// ========================================================================

export { ... };
```

### Import Order

Always order imports:

1. External packages (react, express, etc.)
2. Internal absolute imports (`@/...`)
3. Relative imports (`./`, `../`)

```typescript
// External
import { useState } from 'react';
import { Router } from 'express';

// Internal absolute
import { api } from '@/lib/api';
import { useUserProfile } from '@/features/user';

// Relative
import { MyComponent } from './components/MyComponent';
import type { MyType } from './types';
```

### Naming Conventions

| Item | Convention | Example |
|------|------------|---------|
| Files | kebab-case | `user-profile.tsx`, `auth.middleware.ts` |
| Components | PascalCase | `UserProfile`, `DashboardWidget` |
| Functions | camelCase | `getUserProfile`, `handleSubmit` |
| Constants | SCREAMING_SNAKE | `API_BASE_URL`, `MAX_RETRIES` |
| Types/Interfaces | PascalCase | `UserProfile`, `RegistryItem` |
| Registry files | `*.registry.ts` | `navigation.registry.ts` |
| Registration files | `*.registration.ts` | `navigation.registration.ts` |

### TypeScript

- **Always** use TypeScript types - no `any` unless absolutely necessary
- Prefer `interface` over `type` for object shapes
- Export types that are used across files
- Use `unknown` instead of `any` when type is truly unknown

---

## Registry Pattern

### Creating Registrations

Always create a separate registration file:

```typescript
// features/my-feature/navigation.registration.ts
import { navigationRegistry } from '@/config/navigation.registry';
import { MyIcon } from 'lucide-react';

navigationRegistry.registerMain({
  id: 'my-feature',
  title: 'My Feature',
  url: '/my-feature',
  icon: MyIcon,
  order: 30,
});
```

### Registration Import

Import registrations via side-effect in the feature's index:

```typescript
// features/my-feature/index.ts
// Side-effect imports for registrations
import './navigation.registration';
import './route.registration';

// Named exports
export { MyFeaturePage } from './pages/MyFeaturePage';
export { useMyFeature } from './hooks/useMyFeature';
```

### Order Values

Use consistent order ranges:

| Range | Use For |
|-------|---------|
| 1-10 | Core/primary items (Dashboard, Home) |
| 11-30 | Main features |
| 31-50 | Secondary features |
| 51-70 | Settings, preferences |
| 71-90 | Admin, management |
| 91-99 | Footer items, logout |

---

## Feature Architecture

### Frontend Feature Structure

```
frontend/src/features/[feature]/
├── index.ts                    # Public exports + registration imports
├── routes.config.tsx           # Route definitions
├── navigation.registration.ts  # Navigation registry registration
├── components/                 # Feature components
│   └── MyComponent.tsx
├── pages/                      # Page components
│   └── MyFeaturePage.tsx
├── services/                   # API service layer
│   └── my-feature.service.ts
├── hooks/                      # Custom hooks
│   └── useMyFeature.ts
└── types/                      # TypeScript types
    └── index.ts
```

### Backend Feature Structure

```
backend/src/features/[feature]/
├── index.ts                    # Exports + registration imports
├── [feature].routes.ts         # Express routes
├── [feature].service.ts        # Business logic
├── [feature].types.ts          # Types
├── route.registration.ts       # Route registry registration
└── service.registration.ts     # Service registry registration
```

### What Goes Where

| Code Type | Location |
|-----------|----------|
| Business logic | Services (`*.service.ts`) |
| HTTP handling | Routes (`*.routes.ts`) |
| Data fetching | Hooks (`hooks/`) |
| UI components | Components (`components/`) |
| Page layouts | Pages (`pages/`) |
| Types | Types (`types/`) or colocated |

---

## Error Handling

### Backend Errors

Use HTTP-aware errors from `lib/errors.ts`:

```typescript
import { NotFoundError, UnauthorizedError, BadRequestError } from '../../lib/errors.js';

// 404 - Resource not found
if (!item) {
  throw new NotFoundError('Item not found');
}

// 401 - Authentication required (use for security to prevent enumeration)
if (!user) {
  throw new UnauthorizedError('Unauthorized');
}

// 400 - Bad request
if (!isValid) {
  throw new BadRequestError('Invalid input');
}
```

### Available Error Classes

| Error | Code | Use For |
|-------|------|---------|
| `BadRequestError` | 400 | Invalid input |
| `UnauthorizedError` | 401 | Auth required |
| `ForbiddenError` | 403 | Permission denied |
| `NotFoundError` | 404 | Resource not found |
| `ConflictError` | 409 | Duplicate/conflict |
| `TooManyRequestsError` | 429 | Rate limiting |
| `InternalError` | 500 | Server error |
| `ServiceUnavailableError` | 503 | Service down |

---

## Database Operations

### Always Use Prisma Client from lib

```typescript
import { prisma } from '../../lib/prisma.js';

export async function getItems(userId: string) {
  return prisma.item.findMany({ where: { userId } });
}
```

### Use Transactions for Multi-Table Operations

```typescript
import { withTransaction } from '../../lib/prisma.js';

const result = await withTransaction(async (tx) => {
  const user = await tx.user.create({ data: { ... } });
  const settings = await tx.settings.create({ data: { userId: user.id } });
  return { user, settings };
});
```

### User Routes Pattern

Always use `getOrCreateProfile` to ensure user exists:

```typescript
router.get('/profile', requireAuth, async (req, res) => {
  const profile = await userService.getOrCreateProfile(req.user!.id, req.user!.email);
  res.json(profile);
});
```

---

## Do and Don't

### DO

- ✅ Follow the feature-based architecture
- ✅ Use the registry pattern for extensibility
- ✅ Add file headers to all files
- ✅ Use section dividers for organisation
- ✅ Use the `api` client for frontend API calls
- ✅ Use `getOrCreateProfile` pattern in backend routes
- ✅ Match environment variable names exactly
- ✅ Use side-effect imports for registrations
- ✅ Use registry hooks for reactive updates
- ✅ Bump version when modifying infrastructure files
- ✅ Use named exports (not default exports)
- ✅ Use `cn()` utility for conditional classNames

### DON'T

- ❌ Modify `components/ui/` directly (shadcn components - regenerate instead)
- ❌ Put business logic in route handlers (use services)
- ❌ Hardcode URLs (use environment variables)
- ❌ Skip TypeScript types
- ❌ Create files without header comments
- ❌ Commit `.env` files
- ❌ Manually wire navigation (use registries)
- ❌ Use `any` type without good reason
- ❌ Create documentation files unless explicitly requested
- ❌ Use emojis in code unless explicitly requested

---

## Git Commit Messages

### Format

```
type(scope): description

[optional body]

Co-Authored-By: Claude <assistant> (if AI assisted)
```

### Types

| Type | Use For |
|------|---------|
| `feat` | New feature |
| `fix` | Bug fix |
| `docs` | Documentation only |
| `style` | Formatting, no code change |
| `refactor` | Code change that doesn't fix bug or add feature |
| `perf` | Performance improvement |
| `test` | Adding tests |
| `chore` | Maintenance tasks |

### Examples

```
feat(billing): add subscription management page

fix(auth): resolve token refresh race condition

chore(deps): update Prisma to v6.0
```

---

## Testing Checklist

Before considering work complete, verify:

- [ ] TypeScript compiles: `npm run type-check`
- [ ] Frontend runs: `npm run dev:frontend`
- [ ] Backend runs: `npm run dev:backend`
- [ ] Auth works: Can sign in/out
- [ ] API works: No 401 errors in console
- [ ] Routes work: Navigation to new pages works
- [ ] Registrations work: Items appear in correct locations
- [ ] Version bumped (if infrastructure files changed)

---

## Module-Specific Rules

### When Working on Modules

1. **Check module.ts** - Understand what the module provides
2. **Check templates/** - See what code gets generated
3. **Follow starter template patterns** - Modules extend, not replace
4. **Update module version** - When changing templates or module.ts

### Module Integration Points

Modules typically register with:

| Registry | Purpose |
|----------|---------|
| `navigationRegistry` | Add menu items |
| `settingsPagesRegistry` | Add settings pages |
| `dashboardRegistry` | Add dashboard widgets |
| `routeRegistry` | Add API endpoints |
| `serviceRegistry` | Expose services to other features |

---

## Quick Reference

### Common Commands

```bash
# Development
npm run dev                    # Run both frontend and backend
npm run dev:frontend           # Frontend only
npm run dev:backend            # Backend only

# Type checking
npm run type-check             # Check TypeScript

# Database
cd backend && npx prisma studio        # Open database GUI
cd backend && npx prisma migrate dev   # Run migrations
cd backend && npx prisma generate      # Regenerate client

# Versioning (starter template)
npm run template:version:patch
npm run template:version:minor
npm run template:version:major

# Versioning (modules)
npm run release:patch
npm run release:minor
npm run release:major

# Add shadcn component
cd frontend && npx shadcn@latest add [component]
```

### Environment Variables

| Variable | Location | Purpose |
|----------|----------|---------|
| `VITE_NEON_AUTH_URL` | frontend/.env | Auth endpoint |
| `VITE_API_URL` | frontend/.env | Backend URL |
| `DATABASE_URL` | backend/.env | Pooled DB connection |
| `DIRECT_DATABASE_URL` | backend/.env | Direct DB (migrations) |
| `NEON_AUTH_URL` | backend/.env | JWT validation |
| `PORT` | backend/.env | Backend port |
| `FRONTEND_URL` | backend/.env | CORS origin |

---

## Referencing These Rules

In your CLAUDE.md, add:

```markdown
## LLM Rules Reference

For detailed rules on code conventions, versioning, and patterns, see:
https://saas.uniqueicon.com.au/getting-started/llm-rules/

Key rules to always follow:
1. Bump version when modifying infrastructure files
2. Add file headers to all new files
3. Use the registry pattern for extensibility
4. Follow feature-based architecture
```
