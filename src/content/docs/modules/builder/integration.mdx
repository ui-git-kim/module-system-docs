---
title: Integration
description: How other modules can interact with the Block Builder — services, filters, actions, and registries
sidebar:
  order: 3
---

import { Aside, Tabs, TabItem } from '@astrojs/starlight/components';

This page documents how **other modules** can interact with the Block Builder. If you're building a module that needs to read blocks, react to builder events, or extend the builder's UI, this is your reference.

---

## Service Registry

The builder registers its backend service in the `serviceRegistry`, making it available to other modules:

```typescript
// In any other backend module
import { serviceRegistry } from '../../config/service.registry.js';

const builderService = serviceRegistry.get('builder');

// Now you can call any builder service method
const blocks = await builderService.getBlocksByProject(userId, projectId);
const components = await builderService.getNativeComponents();
const config = await builderService.getConfig('sharedFields');
```

### Type-Safe Access

The builder provides TypeScript type augmentation so `serviceRegistry.get('builder')` is fully typed:

```typescript
// This is registered automatically by the builder module
declare module '../../config/service.registry.js' {
  interface ServiceTypes {
    builder: typeof builderService;
  }
}
```

### Available Service Methods

| Method | Return Type | Description |
|--------|------------|-------------|
| `getNativeComponents()` | `NativeComponentRow[]` | All component definitions |
| `getNativeComponent(type)` | `NativeComponentRow \| null` | Single component by type |
| `saveNativeComponent(input)` | `NativeComponentRow` | Create or update (upsert) |
| `deleteNativeComponent(type)` | `boolean` | Delete by type |
| `importNativeComponents(components)` | `{ imported, errors }` | Bulk import |
| `importComponentsJson(jsonData)` | `{ imported, errors }` | Import from JSON format |
| `getBlocks(userId)` | `BuilderBlock[]` | All blocks for a user |
| `getBlocksByProject(userId, projectId)` | `BuilderBlock[]` | Project-scoped blocks |
| `getGlobalBlocks(userId)` | `BuilderBlock[]` | Global blocks |
| `getSystemBlocks()` | `BuilderBlock[]` | Admin-created system blocks |
| `getBlock(userId, id)` | `BuilderBlock \| null` | Single block (own or system) |
| `createBlock(userId, input)` | `BuilderBlock` | Create with auto-changelog |
| `updateBlock(userId, id, input)` | `BuilderBlock \| null` | Update with changelog append |
| `deleteBlock(userId, id)` | `boolean` | Delete a block |
| `duplicateBlock(userId, id, overrides?)` | `BuilderBlock` | Copy a block (including system) |
| `getCategories(userId)` | `BlockCategoryRow[]` | User's categories |
| `createCategory(userId, input)` | `BlockCategoryRow` | Create a category |
| `deleteCategory(userId, id)` | `boolean` | Delete (clears blocks' categoryId) |
| `getCollections(userId)` | `BlockCollectionRow[]` | User's collections |
| `getCollection(userId, id)` | `BlockCollectionRow \| null` | Single collection |
| `createCollection(userId, input)` | `BlockCollectionRow` | Create a collection |
| `updateCollection(userId, id, input)` | `BlockCollectionRow \| null` | Update a collection |
| `deleteCollection(userId, id)` | `boolean` | Delete (clears blocks' collectionId) |
| `getConfig(key)` | `{ key, value } \| null` | Get a config value |
| `setConfig(key, value)` | `{ key, value }` | Set a config value |
| `getAllConfig()` | `Record<string, unknown>` | Get all config |
| `saveSharedField(name, field)` | `Record<string, unknown>` | Create/update shared field |
| `deleteSharedField(name)` | `Record<string, unknown>` | Delete shared field |
| `getShadcnIndex(forceRefresh?)` | `object` | Get cached shadcn component index |
| `getShadcnComponent(name, style?, forceRefresh?)` | `object` | Get cached component source |
| `syncBuilderComponents(names, style?)` | `{ synced, errors, allDependencies }` | Sync pristine components |
| `getBuilderStyle()` | `string` | Get current shadcn style |
| `setBuilderStyle(style)` | `string` | Set shadcn style |
| `getIconLibrary()` | `string` | Get current icon library |
| `setIconLibrary(library)` | `string` | Set icon library |
| `findUserByHandle(handle)` | `User \| null` | Find user by registry handle |
| `checkHandle(handle)` | `{ available, message? }` | Check handle availability |

---

## Filter Registry

The builder registers one async filter that enriches structure node responses with block metadata.

### `structure.node.response` — Block Count Enrichment

**Hook:** `builder-enrich-node-metadata`
**Priority:** 15 (runs early)

Adds `metadata.builder.blockCount` to structure node API responses. This powers the block count badge on project cards without requiring a separate API call.

```typescript
// What the filter adds to each node response:
{
  ...node,
  metadata: {
    ...existingMetadata,
    builder: {
      blockCount: 5  // Number of blocks scoped to this node
    }
  }
}
```

<Aside type="tip">
Other modules can read this enriched metadata to make decisions. For example, a reporting module could use `metadata.builder.blockCount` to show project statistics.
</Aside>

---

## Action Registry

The builder registers lifecycle hooks via the `actionRegistry` to respond to structure module events.

### `structure.node.deleted` — Cleanup

**Hook:** `builder-cleanup-node-data`
**Priority:** 20

When a project (or any structure node) is deleted, this action removes all associated builder data:

1. All `block` rows with that `projectId`
2. All `block_category` rows with that `projectId`
3. All `block_collection` rows with that `projectId`

```typescript
// Context received:
interface DeletedContext {
  userId: string;
  nodeId: string;     // The deleted node's ID (= projectId for blocks)
  nodeType: string;
}
```

---

## Structure Module Registries (Frontend)

The builder integrates deeply with the Structure module's frontend registries for project detail pages.

### Node Tab Registry

Two tabs are registered for project node detail pages:

**Blocks Tab** (`builder-blocks`)
- Shows all blocks scoped to the project
- Provides "Open in Builder", "Duplicate", and "Delete" actions
- Displays a badge with block count (fetched async)
- Supports toggling global blocks visibility
- Order: 45

**Registry Tab** (`builder-registry`)
- Shows the `components.json` configuration snippet for shadcn CLI
- Displays the project's registry URL, install commands, and available blocks
- Shows private registry token management (if configured)
- Order: 46

### Node Widget Registry

**Blocks Summary Widget** (`builder-blocks-summary`)
- Appears on the node overview page
- Shows a compact summary with recent blocks and quick-add button
- Size: 2x1, Order: 40

### Node Card Extension Registry

**Block Count Badge** (`builder-block-count`)
- Small badge on node cards in list/grid views
- Shows the number of blocks (sourced from `metadata.builder.blockCount`)
- Position: badge, Order: 30

### Node Action Registry

| Action ID | Label | Location | Behaviour |
|-----------|-------|----------|-----------|
| `builder-new-block` | New Block | `detail-header` | Navigates to `/builder?projectId={nodeId}` |
| `builder-view-blocks` | View Blocks | `context-menu` | Navigates to `/blocks?projectId={nodeId}` |

### Node Column Registry

**Block Count Column** (`builder-block-count`)
- Shows block count in table views
- Width: 80px, Alignment: centre
- Reads from `node.metadata.builder.blockCount`
- Order: 50

---

## Property Panel Tab Registry (Frontend)

The builder exports a `propertyPanelTabRegistry` that companion modules use to add tabs to the right-side property panel. When no extension tabs are registered, only the Properties content shows (no tab bar). When tabs are registered, a tab bar appears with Properties + extension tabs.

**Registry file:** `config/property-panel-tab.registry.ts`

### Tab Props

Every registered tab component receives:

```typescript
interface PropertyPanelTabProps {
  node: NodeInstance;      // Currently selected node
  block: NodeInstance;     // Root block (full tree)
  onUpdate: (block: NodeInstance) => void;  // Update the entire block tree
}
```

### Registering a Tab

```typescript
import { propertyPanelTabRegistry } from '@/features/builder';
import type { PropertyPanelTabProps } from '@/features/builder';

propertyPanelTabRegistry.register({
  id: 'style',              // Unique identifier
  label: 'Style',           // Tab label shown in the tab bar
  component: StylePanel,    // Component receiving PropertyPanelTabProps
  order: 30,                // Sort order (Properties is 10, use 20+)
});
```

<Aside type="tip">
The built-in Properties tab has order 10. Use 20 for Logic and 30 for Style to maintain consistent tab ordering across installations.
</Aside>

---

## Code Generation Registry (Frontend)

The builder exports a `codeGenerationRegistry` that companion modules use to hook into the code generation pipeline. Three hook methods are available.

**Registry file:** `config/code-generation.registry.ts`

### Hook Interface

```typescript
interface CodeGenerationHook {
  id: string;

  // Extra import statements for the generated file
  getImports?: (tree: NodeInstance, registry: ComponentRegistry) => string[];

  // Code inside the component function body, before the return statement
  getComponentBody?: (tree: NodeInstance, registry: ComponentRegistry) => string;

  // Transform the props map for a single node during code generation
  // Only runs during final output, NOT preview mode
  transformProps?: (
    node: NodeInstance,
    props: Record<string, string>,  // key → JSX value string
    registry: ComponentRegistry
  ) => Record<string, string>;
}
```

### Registering a Hook

```typescript
import { codeGenerationRegistry } from '@/features/builder';

codeGenerationRegistry.register({
  id: 'builder-logic',

  getImports: (tree, registry) => {
    // Return extra import lines
    return ["import { useState } from 'react'"];
  },

  getComponentBody: (tree, registry) => {
    // Return code to inject before the return statement
    return '  const [count, setCount] = useState(0)';
  },

  transformProps: (node, props, registry) => {
    // Add or modify props on a per-node basis
    props.onClick = '{() => setCount(c => c + 1)}';
    return props;
  },
});
```

<Aside type="note">
`transformProps` receives props as key → JSX value string pairs. For example, `{ variant: '"default"', disabled: '' }` where empty string means boolean shorthand. The returned map is serialised into JSX attributes. This hook is only called during final code output, not during preview rendering.
</Aside>

### How Hooks Are Applied

The code generation pipeline works in three stages:

1. **Imports** — the tree-walker collects component imports, then each registered hook's `getImports()` appends additional import lines
2. **Component Body** — each hook's `getComponentBody()` injects code before the JSX return statement (state declarations, event handlers, etc.)
3. **Props Transform** — during serialisation, `serializePropsWithHooks()` calls each hook's `transformProps()` on every node's props map, allowing mutation (add onClick, modify className, etc.)

---

## Header Toolbar

The builder registers six items in the header toolbar, all visible only on the `/builder` route:

| ID | Type | Position | Icon | Label | Order |
|----|------|----------|------|-------|-------|
| `builder-project-selector` | `custom` | left | — | Select project | 10 |
| `builder-undo` | `action` | left | `Undo2` | Undo | 20 |
| `builder-redo` | `action` | left | `Redo2` | Redo | 21 |
| `builder-import` | `action` | left | `Upload` | Import block | 30 |
| `builder-clear` | `action` | left | `Trash2` | Clear canvas | 31 |
| `builder-save` | `action` | left | `Save` | Save block | 35 |

Actions dispatch custom DOM events (e.g. `builder:save-request`, `builder:undo`) that the `BuilderPage` component listens for.

---

## Dashboard Widget

The builder registers a dashboard widget for quick access:

```typescript
dashboardRegistry.register({
  id: 'builder-overview',
  title: 'Block Builder',
  component: BuilderWidget,
  size: '1x1',
  order: 60,
  category: 'tools',
  description: 'Quick access to Block Builder and recent blocks',
  canHide: true,
  canResize: false,
});
```

---

## Navigation

The builder registers two sidebar navigation items:

| ID | Title | URL | Icon | Order |
|----|-------|-----|------|-------|
| `builder` | Block Builder | `/builder` | `Blocks` | 50 |
| `blocks-library` | Blocks Library | `/blocks` | `Library` | 51 |

---

## Personal Info Fields

The builder registers a custom field in the Personal Information settings:

```typescript
personalInfoFieldsRegistry.register({
  id: 'handle',
  type: 'custom',
  label: 'Shadcn Private Registry Handle',
  description: 'Your unique handle used in registry URLs (e.g. handle.usefoundryui.app)',
  order: 10,
  storage: 'preferences',
  component: HandleField,
});
```

The handle is stored in `user.preferences.handle` and is used to construct registry URLs.

---

## Exported API

### Frontend Exports

The builder's frontend barrel (`features/builder/index.ts`) exports registries, types, and hooks for companion modules:

```typescript
// Registries (for companion module integration)
export { propertyPanelTabRegistry } from './config/property-panel-tab.registry';
export type { PropertyPanelTab, PropertyPanelTabProps } from './config/property-panel-tab.registry';
export { codeGenerationRegistry } from './config/code-generation.registry';
export type { CodeGenerationHook } from './config/code-generation.registry';

// Types
export type {
  NodeInstance,
  ComponentCategory,
  ComponentDefinition,
  PropertyDefinition,
  ComponentRegistry,
} from './types';

// Hooks
export { useBuilder } from './hooks/useBuilder';
export { useCodeGeneration } from './hooks/useCodeGeneration';
export { useProjectBlocks } from './hooks/useProjectBlocks';
export { useBlocksLibrary } from './hooks/useBlocksLibrary';
export {
  useNativeComponents,
  useComponentRegistry,
  NativeComponentsProvider,
} from './hooks/useNativeComponents';
export { useNativeComponentsAdmin } from './hooks/useNativeComponentsAdmin';
```

### Backend Exports

These TypeScript interfaces are exported from the builder's backend barrel (`features/builder/index.ts`) for use by other modules:

```typescript
export { builderService } from './builder.service.js';
export { registryService } from './registry.service.js';
export { initBuilderModule } from './builder.config.js';
export type {
  NativeComponentRow,
  NativeComponentProperty,
  CreateNativeComponentInput,
  BuilderBlock,
  CreateBlockInput,
  UpdateBlockInput,
  ChangelogEntry,
  BlockCategoryRow,
  BlockCollectionRow,
  CreateCollectionInput,
  UpdateCollectionInput,
} from './builder.types.js';
```

---

## Integration Example

Here's how a hypothetical **analytics** module might integrate with the builder:

<Tabs>
  <TabItem label="Backend">
    ```typescript
    // backend/src/features/analytics/builder-metrics.ts
    import { serviceRegistry } from '../../config/service.registry.js';

    async function getProjectBlockMetrics(userId: string, projectId: string) {
      const builderService = serviceRegistry.get('builder');

      const blocks = await builderService.getBlocksByProject(userId, projectId);
      const collections = await builderService.getCollections(userId);

      return {
        totalBlocks: blocks.length,
        globalBlocks: blocks.filter(b => b.isGlobal).length,
        collections: collections.length,
        lastUpdated: blocks[0]?.updatedAt || null,
      };
    }
    ```
  </TabItem>
  <TabItem label="Frontend">
    ```typescript
    // frontend/src/features/analytics/components/BuilderStats.tsx
    import { useProjectBlocks } from '@/features/builder/hooks/useProjectBlocks';

    export function BuilderStats({ projectId }: { projectId: string }) {
      const { blocks, isLoading } = useProjectBlocks(projectId);

      if (isLoading) return <div>Loading...</div>;

      return (
        <div>
          <p>Total blocks: {blocks.length}</p>
          <p>With code: {blocks.filter(b => b.generatedCode).length}</p>
        </div>
      );
    }
    ```
  </TabItem>
  <TabItem label="Code Gen Hook">
    ```typescript
    // frontend/src/features/builder-style/builder-integration.registration.ts
    import { codeGenerationRegistry, propertyPanelTabRegistry } from '@/features/builder';
    import { StylePanel } from './components/StylePanel';

    // Add a Style tab to the property panel
    propertyPanelTabRegistry.register({
      id: 'style',
      label: 'Style',
      component: StylePanel,
      order: 30,
    });

    // Hook into code generation to transform className props
    codeGenerationRegistry.register({
      id: 'builder-style',

      getImports: (tree) => {
        return ["import { cn } from '@/lib/utils'"];
      },

      transformProps: (node, props) => {
        // Merge custom Tailwind classes with existing className
        const customClasses = node.styleClasses as string;
        if (customClasses && props.className) {
          props.className = `{cn(${props.className}, "${customClasses}")}`;
        } else if (customClasses) {
          props.className = `"${customClasses}"`;
        }
        return props;
      },
    });
    ```
  </TabItem>
</Tabs>
