---
title: Integration
description: How other modules can interact with the Block Builder — services, filters, actions, and registries
sidebar:
  order: 3
---

import { Aside, Tabs, TabItem } from '@astrojs/starlight/components';

This page documents how **other modules** can interact with the Block Builder. If you're building a module that needs to read blocks, react to builder events, or extend the builder's UI, this is your reference.

---

## Service Registry

The builder registers its backend service in the `serviceRegistry`, making it available to other modules:

```typescript
// In any other backend module
import { serviceRegistry } from '../../config/service.registry.js';

const builderService = serviceRegistry.get('builder');

// Now you can call any builder service method
const blocks = await builderService.getBlocksByProject(userId, projectId);
const components = await builderService.getNativeComponents();
const config = await builderService.getConfig('sharedFields');
```

### Type-Safe Access

The builder provides TypeScript type augmentation so `serviceRegistry.get('builder')` is fully typed:

```typescript
// This is registered automatically by the builder module
declare module '../../config/service.registry.js' {
  interface ServiceTypes {
    builder: typeof builderService;
  }
}
```

### Available Service Methods

| Method | Return Type | Description |
|--------|------------|-------------|
| `getNativeComponents()` | `NativeComponentRow[]` | All component definitions |
| `getNativeComponent(type)` | `NativeComponentRow \| null` | Single component by type |
| `saveNativeComponent(input)` | `NativeComponentRow` | Create or update (upsert) |
| `deleteNativeComponent(type)` | `boolean` | Delete by type |
| `importNativeComponents(components)` | `{ imported, errors }` | Bulk import |
| `importComponentsJson(jsonData)` | `{ imported, errors }` | Import from JSON format |
| `getBlocks(userId)` | `BuilderBlock[]` | All blocks for a user |
| `getBlocksByProject(userId, projectId)` | `BuilderBlock[]` | Project-scoped blocks |
| `getGlobalBlocks(userId)` | `BuilderBlock[]` | Global blocks |
| `getSystemBlocks()` | `BuilderBlock[]` | Admin-created system blocks |
| `getBlock(userId, id)` | `BuilderBlock \| null` | Single block (own or system) |
| `createBlock(userId, input)` | `BuilderBlock` | Create with auto-changelog |
| `updateBlock(userId, id, input)` | `BuilderBlock \| null` | Update with changelog append |
| `deleteBlock(userId, id)` | `boolean` | Delete a block |
| `duplicateBlock(userId, id, overrides?)` | `BuilderBlock` | Copy a block (including system) |
| `getCategories(userId)` | `BlockCategoryRow[]` | User's categories |
| `createCategory(userId, input)` | `BlockCategoryRow` | Create a category |
| `deleteCategory(userId, id)` | `boolean` | Delete (clears blocks' categoryId) |
| `getCollections(userId)` | `BlockCollectionRow[]` | User's collections |
| `getCollection(userId, id)` | `BlockCollectionRow \| null` | Single collection |
| `createCollection(userId, input)` | `BlockCollectionRow` | Create a collection |
| `updateCollection(userId, id, input)` | `BlockCollectionRow \| null` | Update a collection |
| `deleteCollection(userId, id)` | `boolean` | Delete (clears blocks' collectionId) |
| `getConfig(key)` | `{ key, value } \| null` | Get a config value |
| `setConfig(key, value)` | `{ key, value }` | Set a config value |
| `getAllConfig()` | `Record<string, unknown>` | Get all config |
| `saveSharedField(name, field)` | `Record<string, unknown>` | Create/update shared field |
| `deleteSharedField(name)` | `Record<string, unknown>` | Delete shared field |

---

## Filter Registry

The builder registers one async filter that enriches structure node responses with block metadata.

### `structure.node.response` — Block Count Enrichment

**Hook:** `builder-enrich-node-metadata`
**Priority:** 15 (runs early)

Adds `metadata.builder.blockCount` to structure node API responses. This powers the block count badge on project cards without requiring a separate API call.

```typescript
// What the filter adds to each node response:
{
  ...node,
  metadata: {
    ...existingMetadata,
    builder: {
      blockCount: 5  // Number of blocks scoped to this node
    }
  }
}
```

<Aside type="tip">
Other modules can read this enriched metadata to make decisions. For example, a reporting module could use `metadata.builder.blockCount` to show project statistics.
</Aside>

---

## Action Registry

The builder registers lifecycle hooks via the `actionRegistry` to respond to structure module events.

### `structure.node.deleted` — Cleanup

**Hook:** `builder-cleanup-node-data`
**Priority:** 20

When a project (or any structure node) is deleted, this action removes all associated builder data:

1. All `block` rows with that `projectId`
2. All `block_category` rows with that `projectId`
3. All `block_collection` rows with that `projectId`

```typescript
// Context received:
interface DeletedContext {
  userId: string;
  nodeId: string;     // The deleted node's ID (= projectId for blocks)
  nodeType: string;
}
```

### `structure.node.archived` — Archive Handling

**Hook:** `builder-handle-project-archived`
**Priority:** 20

Currently a no-op placeholder. When a project is archived, its blocks are filtered out naturally by structure queries (the project node is hidden). Future versions may clear cached registry JSON.

### `structure.node.restored` — Restore Handling

**Hook:** `builder-handle-project-restored`
**Priority:** 20

Currently a no-op placeholder. When a project is restored, blocks become visible again automatically. Future versions may regenerate registry output.

---

## Structure Module Registries (Frontend)

The builder integrates deeply with the Structure module's frontend registries for project detail pages.

### Node Tab Registry

Two tabs are registered for project node detail pages:

**Blocks Tab** (`builder-blocks`)
- Shows all blocks scoped to the project
- Provides "Open in Builder" and "New Block" actions
- Displays a badge with block count (fetched async)
- Order: 45

**Registry Tab** (`builder-registry`)
- Shows the `components.json` configuration snippet for shadcn CLI
- Displays the project's registry URL
- Order: 46

### Node Widget Registry

**Blocks Summary Widget** (`builder-blocks-summary`)
- Appears on the node overview page
- Shows a compact summary of project blocks
- Size: 2x1, Order: 40

### Node Card Extension Registry

**Block Count Badge** (`builder-block-count`)
- Small badge on node cards in list/grid views
- Shows the number of blocks (sourced from `metadata.builder.blockCount`)
- Position: badge, Order: 30

---

## Header Toolbar

The builder registers a "Save Block" button in the header toolbar:

```typescript
headerToolbarRegistry.register({
  id: 'builder-save',
  type: 'button',
  position: 'right',
  order: 25,
  icon: Save,
  buttonLabel: 'Save Block',
  buttonVariant: 'default',
  buttonSize: 'sm',
  label: 'Save current block',
  isVisible: () => window.location.pathname.startsWith('/builder'),
  onClick: () => window.dispatchEvent(new CustomEvent('builder:save-request')),
});
```

The button is only visible on the `/builder` route. It dispatches a custom DOM event that the `BuilderPage` component listens for to open the save dialog.

---

## Dashboard Widget

The builder registers a dashboard widget for quick access:

```typescript
dashboardRegistry.register({
  id: 'builder-overview',
  title: 'Block Builder',
  component: BuilderWidget,
  size: '1x1',
  order: 60,
  category: 'tools',
  description: 'Quick access to Block Builder and recent blocks',
  canHide: true,
  canResize: false,
});
```

---

## Navigation

The builder registers two sidebar navigation items:

| ID | Title | URL | Icon | Order |
|----|-------|-----|------|-------|
| `builder` | Block Builder | `/builder` | `Blocks` | 50 |
| `blocks-library` | Blocks Library | `/blocks` | `Library` | 51 |

---

## Exported Types

These TypeScript interfaces are exported from the builder's backend barrel (`features/builder/index.ts`) for use by other modules:

```typescript
export type {
  NativeComponentRow,
  NativeComponentProperty,
  CreateNativeComponentInput,
  BuilderBlock,
  CreateBlockInput,
  UpdateBlockInput,
  ChangelogEntry,
  BlockCategoryRow,
  BlockCollectionRow,
  CreateCollectionInput,
  UpdateCollectionInput,
} from './builder.types.js';
```

---

## Integration Example

Here's how a hypothetical **analytics** module might integrate with the builder:

<Tabs>
  <TabItem label="Backend">
    ```typescript
    // backend/src/features/analytics/builder-metrics.ts
    import { serviceRegistry } from '../../config/service.registry.js';
    import { actionRegistry } from '../../config/action.registry.js';

    // Listen for block creation events (if builder emits them)
    // Or query builder data directly:
    async function getProjectBlockMetrics(userId: string, projectId: string) {
      const builderService = serviceRegistry.get('builder');

      const blocks = await builderService.getBlocksByProject(userId, projectId);
      const collections = await builderService.getCollections(userId);

      return {
        totalBlocks: blocks.length,
        globalBlocks: blocks.filter(b => b.isGlobal).length,
        collections: collections.length,
        lastUpdated: blocks[0]?.updatedAt || null,
      };
    }
    ```
  </TabItem>
  <TabItem label="Frontend">
    ```typescript
    // frontend/src/features/analytics/components/BuilderStats.tsx
    import { useProjectBlocks } from '@/features/builder/hooks/useProjectBlocks';

    export function BuilderStats({ projectId }: { projectId: string }) {
      const { blocks, loading } = useProjectBlocks(projectId);

      if (loading) return <div>Loading...</div>;

      return (
        <div>
          <p>Total blocks: {blocks.length}</p>
          <p>With code: {blocks.filter(b => b.generatedCode).length}</p>
        </div>
      );
    }
    ```
  </TabItem>
</Tabs>
