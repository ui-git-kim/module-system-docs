---
title: Database & API
description: Database schema and API endpoint reference
---

import { Aside } from '@astrojs/starlight/components';

## Database Schema

### structure_node

The universal entity table - every node is stored here.

| Column | Type | Description |
|--------|------|-------------|
| `id` | String | CUID primary key |
| `userId` | String | Owner (foreign key) |
| `nodeType` | String | References node type slug |
| `name` | String | Display name |
| `slug` | String? | URL-safe identifier |
| `description` | String? | Rich text description |
| `data` | JSON | Custom field values |
| `icon` | String? | Custom icon override |
| `color` | String? | Custom colour override |
| `parentId` | String? | Parent node (self-referential for hierarchy) |
| `path` | String? | Materialised path for efficient tree queries |
| `depth` | Int | Tree depth (0 = root) |
| `sortOrder` | Int | Position among siblings |
| `fromNodeId` | String? | Source node for connections |
| `toNodeId` | String? | Target node for connections |
| `connectionType` | String? | Label for the connection relationship |
| `status` | String | `active` / `archived` / `deleted` |
| `isFavorite` | Boolean | User marked as favourite |
| `isPublished` | Boolean | Publishing workflow state |
| `publishedSlug` | String? | Public URL slug when published |
| `settings` | JSON | Node-specific settings |
| `metadata` | JSON | Module extensibility data |
| `createdAt` | DateTime | Creation timestamp |
| `updatedAt` | DateTime | Last update timestamp |

<Aside type="note" title="Self-referential relations">
The schema uses multiple self-referential `@relation` directives on the `structure_node` table to disambiguate the `parentId`, `fromNodeId`, and `toNodeId` foreign keys. This is required by Prisma when a model references itself through multiple fields.
</Aside>

---

### structure_node_type

Configuration for each node type.

| Column | Type | Description |
|--------|------|-------------|
| `id` | String | CUID primary key |
| `userId` | String | Owner |
| `slug` | String | Unique identifier |
| `name` | String | Display name |
| `namePlural` | String | Plural form |
| `description` | String? | Type description |
| `icon` | String | Default Lucide icon name |
| `color` | String? | Default theme colour |
| `moduleId` | String? | Owning module ID |
| `rules` | JSON | Hierarchy rules (allowedParents, allowedChildren, etc.) |
| `features` | JSON | Enabled features (canFavorite, canArchive, etc.) |
| `fields` | JSON | Custom field definitions |
| `navigation` | JSON | Navigation config (sidebar, listPage, detailPage) |
| `isSystem` | Boolean | Protected from user editing |
| `isEnabled` | Boolean | Whether the type is active (database-level flag) |
| `sortOrder` | Int | Display order |
| `createdAt` | DateTime | Creation timestamp |
| `updatedAt` | DateTime | Last update timestamp |

---

### structure_settings

User-specific preferences and UI state.

| Column | Type | Description |
|--------|------|-------------|
| `id` | String | CUID primary key |
| `userId` | String | Unique owner reference |
| `settings` | JSON | Flexible settings object |
| `createdAt` | DateTime | Creation timestamp |
| `updatedAt` | DateTime | Last update timestamp |

---

## API Endpoints

All endpoints are prefixed with `/api/v1/structure`.

### Nodes

| Method | Path | Description |
|--------|------|-------------|
| GET | `/nodes` | List nodes (with filters) |
| GET | `/nodes/:id` | Get single node |
| POST | `/nodes` | Create node |
| PATCH | `/nodes/:id` | Update node |
| DELETE | `/nodes/:id` | Soft delete |
| POST | `/nodes/:id/move` | Move to different parent |
| POST | `/nodes/:id/duplicate` | Duplicate node |
| POST | `/nodes/:id/archive` | Archive |
| POST | `/nodes/:id/restore` | Restore from archive |
| POST | `/nodes/:id/favorite` | Toggle favourite |
| GET | `/nodes/:id/path` | Get ancestor path |
| GET | `/nodes/:id/children` | Get direct children |
| GET | `/nodes/:id/descendants` | Get all descendants |

### Connections

| Method | Path | Description |
|--------|------|-------------|
| GET | `/nodes/:id/connections` | Get connections for a node |
| POST | `/connections` | Create a connection between two nodes |
| DELETE | `/connections/:id` | Remove a connection |

### Tree

| Method | Path | Description |
|--------|------|-------------|
| GET | `/tree` | Get tree structure (optional `?type=` filter) |
| POST | `/reorder` | Batch reorder nodes within a parent |

### Node Types

| Method | Path | Description |
|--------|------|-------------|
| GET | `/types` | List all types (add `?all=true` to include disabled) |
| GET | `/types/:slug` | Get type config |
| POST | `/types` | Create type |
| PATCH | `/types/:slug` | Update type |
| DELETE | `/types/:slug` | Delete type (fails if nodes exist) |

### Settings

| Method | Path | Description |
|--------|------|-------------|
| GET | `/settings` | Get user settings |
| PATCH | `/settings` | Update user settings (merges with existing) |

### Query Parameters

| Param | Description |
|-------|-------------|
| `type` | Filter by node type slug |
| `types` | Comma-separated list of type slugs |
| `parentId` | Filter by parent (use `null` for roots) |
| `status` | `active`, `archived`, `deleted`, or `all` |
| `isFavorite` | `true` or `false` |
| `search` | Search name and description |
| `page`, `limit` | Pagination |
| `sortBy` | `name`, `createdAt`, `updatedAt`, or `sortOrder` |
| `sortOrder` | `asc` or `desc` |
| `includeChildren` | `true` to include child nodes |
| `includeChildrenDepth` | Depth of children to include |
| `includePath` | `true` to include ancestor path |
| `includeConnectionCounts` | `true` to include connection counts |

---

## Request Validation

All POST and PATCH endpoints validate request bodies using [Zod](https://zod.dev) schemas. Invalid requests return a `400 Bad Request` with a descriptive error message.

<Aside type="note" title="Zod schemas">
Schemas are defined in `structure.types.ts` and imported by `structure.routes.ts`. Each schema validates field types, lengths, and required fields. For example, `createNodeSchema` requires `nodeType` and `name`, while `createNodeTypeSchema` validates that slugs are lowercase alphanumeric with hyphens.
</Aside>

**Schemas:**

| Schema | Used by | Key validations |
|--------|---------|----------------|
| `createNodeSchema` | POST `/nodes` | `nodeType` and `name` required, max lengths |
| `updateNodeSchema` | PATCH `/nodes/:id` | All fields optional, max lengths |
| `moveNodeSchema` | POST `/nodes/:id/move` | `newParentId` required (nullable) |
| `reorderNodesSchema` | POST `/reorder` | `nodeIds` array required (min 1) |
| `createConnectionSchema` | POST `/connections` | `fromNodeId`, `toNodeId`, `connectionType` required |
| `createNodeTypeSchema` | POST `/types` | `slug` regex validated, `name`/`namePlural` required |
| `updateNodeTypeSchema` | PATCH `/types/:slug` | All fields optional (partial of create schema) |

---

## Next Steps

- [Module Integration](/modules/structure/integration/) - How other modules integrate with Structure
- [Node Types](/modules/structure/node-types/) - Type configuration interface reference
- [Components & Hooks](/modules/structure/components/) - Frontend component reference
